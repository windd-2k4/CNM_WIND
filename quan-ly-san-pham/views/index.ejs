<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Trang chủ - Cửa hàng</title>
    <style>
        body { font-family: sans-serif; padding: 20px; }
        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px solid #ccc; }
        .filter-box { background: #f4f4f4; padding: 15px; margin-bottom: 20px; border-radius: 5px; }
        table { width: 100%; border-collapse: collapse; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        .status-ok { color: green; font-weight: bold; }
        .status-low { color: orange; font-weight: bold; }
        .status-out { color: red; font-weight: bold; }
        .pagination { margin-top: 20px; text-align: center; }
        .pagination a { padding: 5px 10px; border: 1px solid #ddd; text-decoration: none; margin: 0 2px; }
        .pagination a.active { background: #007bff; color: white; border-color: #007bff; }
        .btn { padding: 5px 10px; text-decoration: none; color: white; border-radius: 3px; border: none; cursor: pointer; }
        .btn-blue { background: #007bff; } .btn-red { background: #dc3545; } .btn-green { background: #28a745; }
        .auth-links a { margin-left: 10px; text-decoration: none; color: #007bff; font-weight: bold; }
    </style>
</head>
<body>
    <div class="top-bar">
        <h1>Cửa hàng trực tuyến</h1>
        <div class="auth-links">
            <% if (user) { %>
                <span>Xin chào, <b><%= user.username %></b> (<%= user.role %>)</span>
                <% if(user.role === 'admin') { %>
                    | <a href="/categories">Quản lý Danh mục</a>
                <% } %>
                | <a href="/logout" style="color: red;">Đăng xuất</a>
            <% } else { %>
                <span>Bạn đang xem với tư cách Khách</span>
                | <a href="/login">Đăng nhập Admin</a>
            <% } %>
        </div>
    </div>

    <div class="filter-box">
        <form action="/" method="GET" style="display: flex; gap: 10px; flex-wrap: wrap;">
            <input type="text" name="search" placeholder="Tên sản phẩm..." value="<%= query.search || '' %>">
            
            <select name="category">
                <option value="">-- Tất cả Danh mục --</option>
                <% categories.forEach(cat => { %>
                    <option value="<%= cat.categoryId %>" <%= query.category == cat.categoryId ? 'selected' : '' %>>
                        <%= cat.name %>
                    </option>
                <% }) %>
            </select>
            
            <input type="number" name="minPrice" placeholder="Giá min" style="width: 80px" value="<%= query.minPrice || '' %>">
            <input type="number" name="maxPrice" placeholder="Giá max" style="width: 80px" value="<%= query.maxPrice || '' %>">
            
            <button type="submit" class="btn btn-blue">Lọc</button>
            <a href="/" class="btn btn-red">Reset</a>
        </form>
    </div>

    <% if (user && user.role === 'admin') { %>
        <div style="margin-bottom: 10px;">
            <a href="/add" class="btn btn-green">+ Thêm sản phẩm mới</a>
        </div>
    <% } %>

    <table>
        <thead>
            <tr>
                <th>Hình ảnh</th>
                <th>Tên sản phẩm</th>
                <th>Danh mục</th>
                <th>Giá</th>
                <th>Tồn kho</th>
                <th>Trạng thái</th>
                <% if (user && user.role === 'admin') { %>
                    <th>Hành động</th>
                <% } %>
            </tr>
        </thead>
        <tbody>
            <% if(products.length === 0) { %>
                <tr><td colspan="<%= (user && user.role === 'admin') ? 7 : 6 %>" style="text-align: center;">Không tìm thấy sản phẩm nào.</td></tr>
            <% } %>
            <% products.forEach(p => { %>
                <tr>
                    <td>
                        <% if(p.url_image) { %> <img src="<%= p.url_image %>" width="60" style="border-radius: 4px;"> <% } %>
                    </td>
                    <td><%= p.name %></td>
                    <td><%= p.categoryName %></td>
                    <td style="color: #d32f2f; font-weight: bold;">
                        <%= new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(p.price) %>
                    </td>
                    <td><%= p.quantity %></td>
                    <td>
                        <% if(p.quantity === 0) { %>
                            <span class="status-out">Hết hàng</span>
                        <% } else if (p.quantity < 5) { %>
                            <span class="status-low">Sắp hết</span>
                        <% } else { %>
                            <span class="status-ok">Còn hàng</span>
                        <% } %>
                    </td>
                    
                    <% if (user && user.role === 'admin') { %>
                        <td>
                            <a href="/edit/<%= p.id %>" class="btn btn-blue">Sửa</a>
                            <form action="/delete/<%= p.id %>" method="POST" style="display:inline" onsubmit="return confirm('Chắc chắn xóa?');">
                                <button class="btn btn-red">Xóa</button>
                            </form>
                        </td>
                    <% } %>
                </tr>
            <% }) %>
        </tbody>
    </table>

    <% if(totalPages > 1) { %>
        <div class="pagination">
            <% for(let i=1; i<=totalPages; i++) { %>
                <a href="/?page=<%= i %>&search=<%= query.search || '' %>&category=<%= query.category || '' %>" 
                   class="<%= currentPage === i ? 'active' : '' %>">
                   <%= i %>
                </a>
            <% } %>
        </div>
    <% } %>
</body>
</html>